<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç´¢å°¼å¾½ç« æ‰¹é‡æŸ¥è¯¢</title>
  <link rel="icon" href="zjsm0-2d1rb-001.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; text-align: center; }
    textarea { width: 100%; height: 150px; font-size: 16px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { margin-top: 10px; padding: 10px 15px; font-size: 16px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    button:hover:enabled { background-color: #45a049; }
    .result { margin-top: 20px; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #007bff; color: white; }
    .badge-link { text-decoration: none; color: white; font-weight: bold; }
    .badge-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <nav style="background:#f0f0f0;padding:12px 20px;margin-bottom:20px;font-size:16px;">
    <a href="badge">ğŸ  å¾½ç« æŸ¥è¯¢</a> |
    <a href="soneium">ğŸ“Š æ´»è·ƒåº¦æŸ¥è¯¢</a>
  </nav>

  <h2>ç´¢å°¼ä»»åŠ¡æ‰¹é‡æŸ¥è¯¢</h2>
  <p>è¾“å…¥é’±åŒ…åœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</p>
  <textarea id="wallets" placeholder="è¾“å…¥é’±åŒ…åœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª"></textarea><br/>
  <button id="queryAllBtn" onclick="queryAndLoadWallets()">æŸ¥è¯¢</button>
  <button onclick="querySelectedBadges()">æŸ¥è¯¢å‹¾é€‰åœ°å€</button>
  <button onclick="exportSelectedToCSV()">å¯¼å‡ºCSV</button>

  <div id="output" class="result">
    <table id="resultTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAllCheckbox" onclick="toggleAllCheckboxes(this.checked)" /></th>
          <th>ç¼–å·</th>
          <th>åœ°å€</th>
          <th><a href="https://app.kyo.finance/" target="_blank" class="badge-link">KYOå¾½ç« </a></th>
          <th><a href="https://app.sakefinance.com/" target="_blank" class="badge-link">Sakeå¾½ç« </a></th>
          <th><a href="https://app.untitledbank.co/" target="_blank" class="badge-link">Untitledå¾½ç« </a></th>
          <th>OG å¾½ç« </th>
          <th><a href="https://launch.sonova.one/launchpad/Sonova_ACS_edition" target="_blank" class="badge-link">Sonovaå¾½ç« </a></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p class="twitter">ä½œè€…æ¨ç‰¹ï¼š<a href="https://x.com/0xXIAOc" target="_blank">@0xXIAOc</a></p>

<script>
const kyoApiUrlPrimary = "https://api.cluster.kyo.finance/quest/1868/0/verify?address=";
const kyoApiUrlBackup = "https://api.cluster.kyo.finance/quest/1868/1/verify?address=";
const sakeApiUrl = "https://stats.sakefinance.com/ecosystembadge?user=";
const ogApiBaseUrl = "https://soneium.blockscout.com/api/v2/addresses/";
const ogNftContract = "0x2A21B17E366836e5FFB19bd47edB03b4b551C89d";
const vercelProxyUrl = "https://sssssss-rh885pjef-7ccccc21xs-projects.vercel.app/api/proxy";

let sonovaShortSet = new Set();

async function loadSonovaShorts() {
  try {
    const res = await fetch("https://raw.githubusercontent.com/7CCCCC21X/sssssss/main/sonova.txt");
    const text = await res.text();
    const lines = text.split("\n").map(l => l.trim().toLowerCase()).filter(Boolean);
    lines.forEach(line => {
      if (line.startsWith("0x") && line.includes("...")) {
        const [pre, post] = line.split("...");
        const short = pre.slice(0, 6) + post.slice(-4);
        sonovaShortSet.add(short);
      }
    });
  } catch (e) {
    console.error("åŠ è½½ Sonova TXT æ–‡ä»¶å¤±è´¥", e);
  }
}

function getShortAddress(addr) {
  return addr.slice(0, 6).toLowerCase() + addr.slice(-4).toLowerCase();
}

async function fetchSonovaStatus(wallet) {
  const short = getShortAddress(wallet);
  return sonovaShortSet.has(short) ? "âœ… æœ‰" : "âŒ æ— ";
}

async function fetchKyoStatus(wallet) {
  try {
    let res = await fetch(kyoApiUrlPrimary + wallet);
    let data = await res.json();
    if (data.eligible) return "âœ… æœ‰";
  } catch {}
  try {
    let res = await fetch(kyoApiUrlBackup + wallet);
    let data = await res.json();
    return data.eligible ? "âœ… æœ‰" : "âŒ æ— ";
  } catch {
    return "âŒ æ— ";
  }
}

async function fetchSakeStatus(wallet) {
  try {
    const res = await fetch(sakeApiUrl + wallet);
    const data = await res.json();
    return data.met_all_requirements ? "âœ… æœ‰" : "âŒ æ— ";
  } catch {
    return "âŒ æ— ";
  }
}

async function fetchUntitledStatus(wallet) {
  try {
    wallet = ethers.utils.getAddress(wallet);
    const t = Date.now();
    const res = await fetch(`${vercelProxyUrl}?address=${wallet}&start=4085424&end=5165422&t=${t}`);
    const data = await res.json();
    const txCount = data.transactions?.length ?? 0;
    return txCount >= 10 ? "âœ… æœ‰" : `âŒ æ—  (${txCount})`;
  } catch {
    return "âŒ æ— ";
  }
}

async function fetchOgStatus(wallet) {
  try {
    const res = await fetch(`${ogApiBaseUrl}${wallet}/tokens?type=ERC-1155`);
    const data = await res.json();
    const items = data.items || [];
    return items.some(i => i.token.address.toLowerCase() === ogNftContract.toLowerCase()) ? "âœ… æœ‰" : "âŒ æ— ";
  } catch {
    return "âŒ æ— ";
  }
}

async function queryAndLoadWallets() {
  await loadSonovaShorts(); // ç¡®ä¿å…ˆåŠ è½½Sonovaæ–‡ä»¶

  const queryBtn = document.getElementById("queryAllBtn");
  queryBtn.disabled = true;

  const wallets = document.getElementById("wallets").value.trim().split("\n").map(w => w.trim()).filter(Boolean);
  const tableBody = document.querySelector("#resultTable tbody");
  tableBody.innerHTML = "";

  const results = [];

  for (let i = 0; i < wallets.length; i++) {
    const wallet = wallets[i];
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="checkbox" class="wallet-checkbox" data-wallet="${wallet}" /></td>
      <td>${i + 1}</td>
      <td>${wallet}</td>
      <td class="kyo-status">æŸ¥è¯¢ä¸­...</td>
      <td class="sake-status">æŸ¥è¯¢ä¸­...</td>
      <td class="untitled-status">æŸ¥è¯¢ä¸­...</td>
      <td class="og-status">æŸ¥è¯¢ä¸­...</td>
      <td class="sonova-status">æŸ¥è¯¢ä¸­...</td>
    `;
    tableBody.appendChild(row);

    const [kyo, sake, untitled, og, sonova] = await Promise.all([
      fetchKyoStatus(wallet),
      fetchSakeStatus(wallet),
      fetchUntitledStatus(wallet),
      fetchOgStatus(wallet),
      fetchSonovaStatus(wallet),
    ]);

    row.querySelector(".kyo-status").innerText = kyo;
    row.querySelector(".sake-status").innerText = sake;
    row.querySelector(".untitled-status").innerText = untitled;
    row.querySelector(".og-status").innerText = og;
    row.querySelector(".sonova-status").innerText = sonova;

    results.push({ wallet, kyo, sake, untitled, og, sonova });
  }

  localStorage.setItem("wallets", JSON.stringify(wallets));
  localStorage.setItem("queryResults", JSON.stringify(results));
  queryBtn.disabled = false;
}

function toggleAllCheckboxes(checked) {
  document.querySelectorAll(".wallet-checkbox").forEach(cb => cb.checked = checked);
}

function exportSelectedToCSV() {
  const selected = Array.from(document.querySelectorAll(".wallet-checkbox:checked"));
  let csv = "ç¼–å·,åœ°å€,KYOå¾½ç« ,Sakeå¾½ç« ,Untitledå¾½ç« ,OGå¾½ç« ,Sonovaå¾½ç« \n";
  selected.forEach((cb, idx) => {
    const row = cb.closest("tr");
    const cells = row.querySelectorAll("td");
    const values = [idx + 1, cells[2].innerText, cells[3].innerText, cells[4].innerText, cells[5].innerText, cells[6].innerText, cells[7].innerText];
    csv += values.join(",") + "\n";
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "selected_badges.csv";
  a.click();
}

window.addEventListener("DOMContentLoaded", () => {
  const cached = localStorage.getItem("wallets");
  if (cached) {
    document.getElementById("wallets").value = JSON.parse(cached).join("\n");
  }

  const cachedResults = localStorage.getItem("queryResults");
  if (cachedResults) {
    const results = JSON.parse(cachedResults);
    const tableBody = document.querySelector("#resultTable tbody");
    tableBody.innerHTML = "";
    results.forEach((r, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="checkbox" class="wallet-checkbox" data-wallet="${r.wallet}" checked /></td>
        <td>${i + 1}</td>
        <td>${r.wallet}</td>
        <td class="kyo-status">${r.kyo}</td>
        <td class="sake-status">${r.sake}</td>
        <td class="untitled-status">${r.untitled}</td>
        <td class="og-status">${r.og}</td>
        <td class="sonova-status">${r.sonova}</td>
      `;
      tableBody.appendChild(row);
    });
  }
});
</script>
</body>
</html>
